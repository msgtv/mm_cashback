javascript:!function(){let e=document.createElement("div"),t=document.createElement("form");e.id="bc-id-overlay",t.id="bc-id-form";let n="DST",o="CHK",r="bc-id-w-f",a="bc-id-min-per",i="bc-id-sort",l="bc-id-max-page",c="megamarket.ru",s=`<div id="div-${i}"><label for="${i}">Сорт-ка:</label><select id="${i}"><option value="TTC" selected>Цена-кэшбэк</option><option value="DSC">По убыв. %</option></select></div>`;function d(){window.bestCashFormOpen=!1}function u(){if(console.log(`Form is open? Answer: ${window.bestCashFormOpen}`),window.bestCashFormOpen)return;let s=`<label for="${r}">Что ищем?</label><select id="${r}"><option value="${n}" selected>Скидку</option><option value="${o}">Кэшбэк</option></select><label for="${a}"">Мин. %:</label><input type="number" id="${a}" name="min-percent" value="" required">`;window.MyBCL?s+=`<p><b>${window.MyBCL.length} шт.</b></p>`:s+=`<label for="${l}">Страниц:</label><input type="number" id="${l}" name="max-page"">`,s+=`<input id="bc-id-smt" type="submit" value="СТАРТ">`,window.location.hostname!=c?(t.tagName="DIV",s=`<div><h4>Перейдите на <a href="https://megamarket.ru/catalog/">${c}</a></h4></div>`):h().length||window.MyBCL?t.addEventListener("submit",function(e){var t,n,c,s;e.preventDefault();let u=parseInt(document.getElementById(a).value),m=document.getElementById(r).value,p=m==o?document.getElementById(i).value:void 0,v;v=window.MyBCL?0:parseInt(document.getElementById(l).value),f(),t=u,n=v,c=m,t<0&&(t=0),w(t,n,c,s=p),d()}):(t.tagName="DIV",s=`<div><h4>Товары не обнаружены</h4></div>`),t.insertAdjacentHTML("beforeend",s),document.body.insertAdjacentElement("beforeend",e),document.body.insertAdjacentElement("beforeend",t),window.bestCashFormOpen=!0,e.addEventListener("click",f,{once:!0})}function f(){t.parentNode.removeChild(t),e.parentNode.removeChild(e),d(),window.bestCashFormOpen=!1}document.addEventListener("change",function(e){var t=e.target;if(t.id==r){var n=document.getElementById(i);if(t.value==o)n||document.getElementById(r).insertAdjacentHTML("afterend",s);else if(n){var a=document.getElementById(`div-${i}`);a&&a.parentNode.removeChild(a)}}});let m=["div.catalog-item-mobile","div.catalog-item",],p=".item-money .item-price span",v=[".catalog-items-list",],b=[".catalog-items-list__show-more",".cnc-catalog-listing__show-more","button.catalog-listing__show-more",],y=[".catalog-items-list__out-of-stock-heading"];function g(e){return parseInt(e.replace(" ",""))}function h(){let e=[];for(let t of m)if((e=document.querySelectorAll(t)).length)break;return Array.from(e)}function C(e){try{e.parentNode.removeChild(e)}catch{}}function $(e,t){let n;n=t==o?".item-money .item-bonus span.bonus-amount":'span[class*="old-price-discount"][class$="price"]';let r=e.querySelector(p).textContent,a=e.querySelector(n).textContent;return pp=g(r),bp=g(a),ps=t==o?Math.round(bp/pp*100):100-Math.round(pp/bp*100),[pp,bp,ps]}function L(e,t){return parseInt(e.dataset[t])}function B(e,t){try{var n=L(e,"percents"),o=L(t,"percents");if(n>o)return -1;if(n==o)return 0;if(n<o)return 1}catch{}}function E(e,t){var n=L(e,"totalCost"),o=L(t,"totalCost");return n>o?1:n==o?0:n<o?-1:void 0}function M(){return new Promise(e=>setTimeout(e,3e3))}async function k(e,t=0){let n=function e(){let t;for(let n of b)if(t=document.querySelector(n))break;return t}();t+=1;let o;for(;!(o=h()).length;)console.log("page loading waiting..."),await M(1e3);if(!function e(t){t.forEach(function(e,t){C(e)})}(o),window.MyBCL=window.MyBCL.concat(Array.from(o)),e&&t==e||e<1){C(n);return}if(function e(){for(var t of y)if(document.querySelectorAll(t).length)return!0;return!1}()){let r;(r=document.querySelector(".catalog-listing__out-of-stock_items"))&&C(r),C(n);return}return n?(n.click(),await M(),await k(e,t)):void 0}async function w(e,t,n,r){window.MyBCL||(window.MyBCL=[],await k(t,0));!function e(t,n,r,a){let i=[];for(let l of window.MyBCL)try{var[c,s,d]=$(l,r),u=l.cloneNode(!0);if(d>=t){i.push(u);var f=c-s;C(u.querySelector("div.discount-percentage")),u.dataset.totalCost=f,u.dataset.percents=d;var m=u.querySelector(p),v=`${d}%`;r==o&&(v=`${f} ₽ | `+v),m.insertAdjacentHTML("beforebegin",`<span style="color:red;">${v}</span><br>`)}}catch{continue}n.innerHTML="",i.sort("TTC"==a?E:B),i.forEach((e,t)=>n.appendChild(e))}(e,function e(){let t;for(let n of v)if(t=document.querySelector(n))break;return t}(),n,r)}window.IntervalNum=0,window.MyBCLCssLoaded||fetch("https://raw.githubusercontent.com/msgtv/mm_cashback/main/bookmarklet.styles.css").then(e=>{if(!e.ok)throw Error("Network");return e.text()}).then(e=>{let t=document.createElement("style");t.innerHTML=e,document.head.insertAdjacentElement("beforeend",t),u(),window.MyBCLCssLoaded=!0}).catch(e=>{}),u()}();