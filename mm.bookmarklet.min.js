!function(){const e=document.createElement("div"),t=document.createElement("form"),n="CHK",o="TTC",r="bc-id-w-f",l="bc-id-min-per",i="bc-id-sort",a="bc-id-max-page",c="bc-id-smt",s="megamarket.ru";let d=document.createElement("style");const u=`<div id="div-${i}">\n                              <label for="${i}">\n                                Сорт-ка:\n                              </label>\n                              <select id="${i}">\n                                <option value="DSC" selected>По убыв. %</option>\n                                <option value="${o}">Цена-кэшбэк</option>\n                              </select>\n                            </div>`;function m(){window.bestCashFormOpen=!1}function f(){t.parentNode.removeChild(t),e.parentNode.removeChild(e),d.parentNode.removeChild(d),m()}document.addEventListener("change",(function(e){var t=e.target;if(t.id==r){var o=document.getElementById(i);if(t.value==n){if(!o)document.getElementById(c).insertAdjacentHTML("beforebegin",u)}else if(o){var l=document.getElementById(`div-${i}`);l&&l.parentNode.removeChild(l)}}}));const g=["div.catalog-item-mobile","div.catalog-item"],y=".item-money .item-price span",v=".item-money .item-bonus span.bonus-amount",h='span[class*="old-price-discount"][class$="price"]',$=[".catalog-items-list"],x=[".catalog-items-list__show-more",".cnc-catalog-listing__show-more","button.catalog-listing__show-more"],w=".catalog-listing__out-of-stock_items",C=[".catalog-items-list__out-of-stock-heading"];function E(e){return parseInt(e.replace(" ",""))}function I(){let e=[];for(let t of g)if(e=document.querySelectorAll(t),e.length)break;return Array.from(e)}function k(e){e.parentNode.removeChild(e)}function S(e,t){let o;o=t==n?v:h;let r=e.querySelector(y).textContent,l=e.querySelector(o).textContent;return pp=E(r),bp=E(l),ps=t==n?Math.round(bp/pp*100):100-Math.round(pp/bp*100),[pp,bp,ps]}function q(e,t){return parseInt(e.querySelector(v).dataset[t])}function A(e,t){var n=q(e,"percents"),o=q(t,"percents");return n>o?-1:n==o?0:n<o?1:void 0}function _(e,t){var n=q(e,"totalCost"),o=q(t,"totalCost");return n>o?1:n==o?0:n<o?-1:void 0}function T(){return new Promise((e=>setTimeout(e,3e3)))}async function L(e,t=0,n=[]){let o,r=function(){let e;for(let t of x)if(e=document.querySelector(t),e)break;return e}();for(t+=1,console.log(`page - ${t}`);o=I(),!o.length;)console.log("page loading waiting..."),await T();return function(e){e.forEach((function(e,t){k(e)}))}(o),n=n.concat(Array.from(o)),e&&t==e||e<1?(k(r),n):function(){for(var e of C)if(document.querySelectorAll(e).length)return!0;return!1}()?(function(){let e=document.querySelector(w);e&&k(e)}(),k(r),n):r?(r.click(),await T(),await L(e,t,n)):(console.log("no btn"),n)}window.IntervalNum=0,function(){if(console.log(`Form is open? Answer: ${window.bestCashFormOpen}`),window.bestCashFormOpen)return;d.innerHTML=`\n      label[for="${r}"], label[for="${l}"], label[for="${i}"], label[for="${a}"] {\n        display: block;\n        margin-bottom: 5px;\n        font-size: 12px;\n        color: #333;\n      }\n\n      #${r}, #${l}, #${i}, #${a} {\n        display: block;\n        width: 100%;\n        padding: 10px;\n        margin-bottom: 10px;\n        font-size: 16px;\n        border: 2px solid #3498db;\n        border-radius: 5px;\n        transition: border-color 0.3s;\n      }\n\n      #${r}:focus, #${l}:focus, #${i}:focus, #${a}:focus {\n        outline: none;\n        border-color: #2ecc71;\n      }\n\n      #${r}:hover, #${l}:hover, #${i}:hover, #${a}:hover {\n        border-color: #2ecc71;\n      }\n\n      #${c} {\n        display: block;\n        margin: 0 auto;\n        padding: 5px 20px;\n        font-size: 16px;\n        text-align: center;\n        text-decoration: none;\n        cursor: pointer;\n        border: 2px solid #3498db;\n        border-radius: 5px;\n        color: #ffffff;\n        background-color: #3498db;\n      }`,e.id="bc-id-overlay",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="#0009",e.style.zIndex="9998",t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="20px",t.style.background="#fff",t.style.border="1px solid; #ccc",t.style.boxShadow="rgb(255 255 255) 0px 0px 10px",t.style.zIndex="9999",t.style.borderRadius="3px";const u=`<label for="${r}">\n                    Что ищем?\n                    </label>\n                    <select id="${r}">\n                      <option value="${n}">Кэшбэк</option>\n                      <option value="DST" selected>Скидку</option>\n                    </select>\n                    <label for="${l}"">\n                    Мин. %:\n                    </label>\n                    <input type="number" id="${l}" name="min-percent" value="" required">\n                    <label for="${a}">Страниц:</label>\n                    <input type="number" id="${a}" name="max-page"">\n                    <input id="${c}" type="submit" value="СТАРТ">`;window.location.hostname!=s?(t.tagName="DIV",u=`<div><h4>Перейдите на <a href="https://megamarket.ru/catalog/">${s}</a></h4></div>`):I().length?t.addEventListener("submit",(function(e){e.preventDefault();const t=parseInt(document.getElementById(l).value),c=parseInt(document.getElementById(a).value),s=document.getElementById(r).value,d=s==n?document.getElementById(i).value:void 0;console.log([t,T,c]),f(),function(e,t,r,l){e<0&&(e=0);data=async function(e,t,r,l,i=0){items=await L(t,i);let a=function(){let e;for(let t of $)if(e=document.querySelector(t),e)break;return e}();return data=function(e,t,r,l,i=[]){i.length||(i=I());console.log("start parsing");let a=[];for(let t of i)try{[p,b,ps]=S(t,r),ps<e||a.push(t);let o=t.querySelector(v);if(o.textContent.includes("%"))continue;if(r==n){o.textContent+=` [${ps}%]`;var c=p-b;o.dataset.totalCost=c,t.querySelector(y).insertAdjacentHTML("beforebegin",`<span style="color:green;">${c} ₽</span><br>`)}o.dataset.percents=ps}catch{continue}t.innerHTML="";var s=l==o?_:A;return a.sort(s),a.forEach(((e,n)=>t.appendChild(e))),console.log("end parsing"),console.log(`elements - ${a.length}`),{items:i,newItems:a}}(e,a,r,l,items),data}(e,t,r,l,0),data}(t,c,s,d),m()})):(t.tagName="DIV",u="<div><h4>Товары не обнаружены</h4></div>"),t.insertAdjacentHTML("beforeend",u),document.body.insertAdjacentElement("beforeend",e),document.body.insertAdjacentElement("beforeend",t),document.head.insertAdjacentElement("beforeend",d),window.bestCashFormOpen=!0,e.addEventListener("click",f,{once:!0})}()}();